<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器启动失败 - 生活管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .error-container {
            background: white;
            border-radius: 20px;
            padding: 60px 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
        }

        .error-icon {
            font-size: 80px;
            margin-bottom: 30px;
            display: block;
        }

        .error-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .error-message {
            font-size: 16px;
            line-height: 1.6;
            color: #666;
            margin-bottom: 40px;
        }

        .error-details {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            border-left: 4px solid #e74c3c;
        }

        .error-details h3 {
            color: #e74c3c;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .error-details ul {
            list-style: none;
            margin-left: 0;
        }

        .error-details li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 20px;
        }

        .error-details li::before {
            content: "•";
            color: #e74c3c;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .system-info {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #999;
        }

        @media (max-width: 600px) {
            .error-container {
                padding: 40px 30px;
            }
            
            .error-title {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-icon">⚠️</div>
        <h1 class="error-title">服务器启动失败</h1>
        <p class="error-message">
            生活管理系统的后端服务器无法启动。这通常是由于Python环境配置问题导致的。
        </p>

        <div class="error-details">
            <h3>可能的解决方案：</h3>
            <ul>
                <li>确保已安装 Python 3.8 或更高版本</li>
                <li>确保已安装所有必要的依赖包</li>
                <li>检查端口 8000 是否被其他程序占用</li>
                <li>尝试重新启动应用程序</li>
                <li>检查防火墙和安全软件设置</li>
            </ul>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="retryConnection()">
                重试连接
            </button>
            <button class="btn btn-secondary" onclick="openDiagnostics()">
                诊断信息
            </button>
            <button class="btn btn-secondary" onclick="openHelp()">
                获取帮助
            </button>
        </div>

        <div class="system-info">
            <div id="systemInfo">
                平台: <span id="platform">-</span> | 
                版本: <span id="version">-</span> | 
                时间: <span id="timestamp">-</span>
            </div>
        </div>
    </div>

    <script>
        // 显示系统信息
        document.addEventListener('DOMContentLoaded', () => {
            if (window.electronAPI) {
                // 获取平台信息
                document.getElementById('platform').textContent = window.electronAPI.getPlatform();
                
                // 获取版本信息
                window.electronAPI.getAppVersion().then(version => {
                    document.getElementById('version').textContent = version;
                });
            }
            
            // 显示当前时间
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
        });

        async function retryConnection() {
            const btn = event.target;
            const originalText = btn.textContent;
            
            btn.textContent = '重试中...';
            btn.disabled = true;
            
            try {
                // 尝试连接服务器
                const response = await fetch('http://localhost:8000', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    // 连接成功，重新加载页面
                    window.location.href = 'http://localhost:8000';
                } else {
                    throw new Error('服务器响应异常');
                }
            } catch (error) {
                alert('连接失败，请检查服务器状态或尝试重启应用。');
                console.error('重试连接失败:', error);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function openDiagnostics() {
            const diagnostics = {
                timestamp: new Date().toISOString(),
                platform: window.electronAPI?.getPlatform() || 'unknown',
                userAgent: navigator.userAgent,
                location: window.location.href,
                localStorage: Object.keys(localStorage),
                sessionStorage: Object.keys(sessionStorage)
            };

            const newWindow = window.open('', '_blank', 'width=600,height=800');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>诊断信息 - 生活管理系统</title>
                        <style>
                            body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                            pre { background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; white-space: pre-wrap; }
                            h2 { color: #333; }
                        </style>
                    </head>
                    <body>
                        <h2>生活管理系统 - 诊断信息</h2>
                        <pre>${JSON.stringify(diagnostics, null, 2)}</pre>
                        <h2>错误日志</h2>
                        <pre id="errorLog">暂无错误日志</pre>
                        <script>
                            // 收集控制台错误
                            const errors = [];
                            const originalError = console.error;
                            console.error = function(...args) {
                                errors.push(args.join(' '));
                                document.getElementById('errorLog').textContent = errors.join('\\n');
                                originalError.apply(console, args);
                            };
                        </script>
                    </body>
                </html>
            `);
        }

        function openHelp() {
            // 打开帮助页面或文档
            if (window.electronAPI) {
                // 在Electron环境中，可以打开本地帮助文档
                alert('帮助文档功能正在开发中。请联系技术支持获取帮助。');
            } else {
                // 在浏览器中打开在线帮助
                window.open('https://github.com/your-repo/life-management/wiki/troubleshooting', '_blank');
            }
        }

        // 自动重试机制
        let retryCount = 0;
        const maxRetries = 3;
        const retryInterval = 10000; // 10秒

        function autoRetry() {
            if (retryCount < maxRetries) {
                retryCount++;
                console.log(`自动重试 ${retryCount}/${maxRetries}`);
                
                fetch('http://localhost:8000')
                    .then(response => {
                        if (response.ok) {
                            window.location.href = 'http://localhost:8000';
                        }
                    })
                    .catch(() => {
                        if (retryCount < maxRetries) {
                            setTimeout(autoRetry, retryInterval);
                        }
                    });
            }
        }

        // 5秒后开始自动重试
        setTimeout(autoRetry, 5000);

        // 显示重试进度
        let countdown = 5;
        const countdownTimer = setInterval(() => {
            if (countdown > 0) {
                document.title = `${countdown}秒后自动重试 - 生活管理系统`;
                countdown--;
            } else {
                document.title = '服务器启动失败 - 生活管理系统';
                clearInterval(countdownTimer);
            }
        }, 1000);
    </script>
</body>
</html>